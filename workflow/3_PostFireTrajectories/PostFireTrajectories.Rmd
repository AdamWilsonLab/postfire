---
title: "PostFireTrajectories"
author: "Adam M. Wilson"
date: "July 22, 2014"
output: html_document
    toc: true
    theme: cerulean
    keep_md: true  


```{r,setup,echo=F,cache=F,results='hide',message=FALSE}
##  First some set up
source("../1_setup.R")
opts_knit$set(root.dir=getwd(),cache=T,base.url = NULL)

```


# Data

Load the model data we made in [DataPrep.Rmd](../1_Data/DataPrep.Rmd)
```{r}
load("data/modeldata.Rata")
```


## Change through time

It's still hard to see change while looking at the full peninsula, so let's:

1. pick a few pixels and plot NDVI as a function of time.  
2. zoom in on a smaller region

But first we need to pick a pixel (or a few) to plot.  There are a few ways to do this.  First let's try extracting values from a single cell:
```{r}
plot(c(ndvi[199165])~getZ(ndvi),type="l",ylab="NDVI",xlab="Year")
```

Or, we can use the `click` function (in Raster) that allows you to pick points on the map.  First we need to plot the data using the plot() command.

```{r,eval=FALSE}
## first plot the data
plot(l5[[1]])
## specify how many points you want to select
nclicks=5
d=click(l5,xy=T,n=nclicks,cell=T,id=TRUE,type="l")
## now click on the map to select your points

## reshape the data for easy plotting
d$id=1:nrow(d)
d2=melt(d,id.var=c("x","y","cell","id"));colnames(d2)=c("X","Y","Point","id","Year","NDVI")
d2$Year=as.numeric(sub("Y","",d2$Year))
p1=xyplot(NDVI~Year,groups=id,data=d2,type="l",auto.key=list(x=0,y=1))
p2=levelplot(L5[[1]],col.regions=cndvi()$col,cuts=length(cndvi()$at),at=cndvi()$at,margin=F)+
  layer(panel.text(d$x,d$y,d$id,col="red",cex=2))
print(c(p1,p2,merge.legends=T))
```


### Regional plot

Alternatively, we can aggregate the data from a larger region.  First import a shapefile of the reserves on the peninsula and the fire data.
```{r}
reserves=readOGR(paste0(datadir,"raw/reserves/"),"reserves")
reserves=spTransform(reserves,CRS(proj4string(dem)))


fi=readOGR(dsn=paste0(datadir,"raw/Fire"), layer="CapePenFires") #Cape Peninsula fires history layers 1962-2007
fi=spTransform(fi,CRS(proj4string(dem)))
```

Now select a region to explore.  You could do a single fire, a single reserve, or any combination of regions using the code below.  
```{r}
resname="SILVERMINE"

reg1=reserves[which(reserves$MASTERNAME==resname),]
#reg1=fi[which(fi$FIREID==2000103),]
```

```{r regextract}
rd=extract(ig,reg1)


ggplot(rdl[rdl$cell%in%sample(rdl$cell,50),],aes(x=year,y=ndvi,group=cell))+
  geom_line(size=.2,alpha=.5)+
  stat_smooth(fill = "grey50",aes(group = 1),col="red")

ggplot(rdl[rdl$cell%in%sample(rdl$cell,100),],aes(x=age,y=ndvi,group=cell))+
  geom_line(size=.2,alpha=.5)+
  stat_smooth(fill = "grey50",aes(group = 1),col="red")+xlim(0, 30)

```



> ### Exercise: 
> 1. Explore the map for areas you are familiar with. Do you see any patterns?
> 2. Can you identify any fires looking at the NDVI profiles?

```{r,purl,echo=FALSE,results='hide',messages=F,error=FALSE,background=T}
## this chunk outputs a copy of this script converted to a 'normal' R file with comments
purl("workflow/ExploreNDVI/ExploreNDVI.Rmd",documentation=2,output = "workflow/ExploreNDVI/ExploreNDVI.R", quiet = TRUE) 
```


```{r}



```

plot(Y1987~Elevation,data=dat)

Select a few pixels to explore.  

ndvi2=do.call(rbind,ndvi)

xyplot(evi~age|id,type="l",data=ndvi2[ndvi2$id%in%sample(ndvi2$id,1000),],layout=c(2,1))

minage=as.numeric(names(which(tapply(ndvi2$age,ndvi2$id,min,na.rm=T)<1)))
xyplot(evi~age,groups=id,type="l",data=ndvi2[ndvi2$id%in%minage[1:1000],])


st=data.frame(ndvi=tapply(ndvi2$ndvi,round(ndvi2$age,1),quantile,c(0.025,.25,.5,.75,.975),na.rm=T)); st$age=as.numeric(rownames(st))
plot(ndvi~age,data=st,type="l",xlim=c(0,10))

#############################
### Explore the fitted breaks

table(ndvi2$breakfire)





```{r,purl,echo=FALSE,results='hide',messages=F,error=FALSE,background=T}
## this chunk outputs a copy of this script converted to a 'normal' R file with comments
purl("workflow/ExploreNDVI/ExploreNDVI.Rmd",documentation=2,output = "workflow/ExploreNDVI/ExploreNDVI.R", quiet = TRUE) 
```
