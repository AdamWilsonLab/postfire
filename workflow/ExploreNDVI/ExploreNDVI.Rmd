---
title: "NDVI Exploration"
author: "Adam M. Wilson"
#date: Today
output:
  html_document:
    toc: true
    theme: cerulean
  pdf_document:
    toc: true
    highlight: zenburn

---


Let's explore the LANDSAT data.

```{r,setup,echo=F,cache=F,results='hide',message=FALSE}
##  First some set up
source("../1_setup.R")
knitr_options(opts_chunk=list(cache=T,root.dir="../..",upload.fun = imgur_upload, base.url = NULL))

```


# Data

## Load LANDSAT data
```{r}
# LANDSAT 5
L5=stack(paste0(datadir,"ee_ZA_output/20140630_54ef46e7ea_LT5_L1T_ANNUAL_GREENEST_TOA__1984-2012-0000000000-0000000000.tif"))
NAvalue(L5)=0
gain(L5)=.01
names(L5)=paste0("Y",1984:2012)
L5=setZ(L5,1984:2012)

# LANDSAT 7
L7=stack(paste0(datadir,"ee_ZA_output/20140630_54ef46e7ea_LE7_L1T_ANNUAL_GREENEST_TOA__1999-2014-0000000000-0000000000.tif"))
NAvalue(L7)=0
gain(L7)=.01
names(L7)=paste0("Y",1999:2014)
L7=setZ(L7,1999:2014)

# LANDSAT 8
L8=stack(paste0(datadir,"ee_ZA_output/20140630_54ef46e7ea_LC8_L1T_ANNUAL_GREENEST_TOA__2013-2014-0000000000-0000000000.tif"))
gain(L8)=.01
NAvalue(L8)=0
names(L8)=paste0("Y",2013:2014)
L8=setZ(L8,2013:2014)
```

Let's check out one of the LANDSAT objects.  Raster provides a summary by just typing the object's name:
```{r}
L5
```


And a plot of the first year:
```{r fig.width=7, fig.height=6}
levelplot(L5[[1]],col.regions=cndvi()$col,cuts=length(cndvi()$at),at=cndvi()$at,margin=F)
```


That's strange, EarthEngine has added some columns to the tif to the West of the peninsula (see all that white space?).  Let's crop it.  First define an 'extent' in lat-lon coordinates and project them to 
```{r}
peninsula=extent(250000,270210,6189390,6247260)
L5=crop(L5,peninsula)
```

Let's try the plot again:
```{r fig.width=7, fig.height=6}
levelplot(L5[[1]])#,col.regions=cndvi()$col,cuts=length(cndvi()$at),at=cndvi()$at,margin=F)
```
Much better.  Now let's look at a few different years.

```{r fig.width=7, fig.height=6}
years=1998:2005
yearind=which(getZ(L5)%in%years)
levelplot(L5[[yearind]],col.regions=cndvi()$col,cuts=length(cndvi()$at),at=cndvi()$at,layout=c(length(years),1))
```

## Change through time

It's still hard to see change while looking at the full peninsula, so let's:

1. zoom in on a smaller region
2. pick a few pixels and plot NDVI as a function of time.  

### Regional plot



But first we need to pick a pixel (or a few) to plot.  There are a few ways to do this.  First let's try extracting values from a single cell:
```{r}
plot(c(L7[199165])~getZ(L7),type="l",ylab="NDVI",xlab="Year")
```

Or, we can use the `click` function (in Raster) that allows you to pick points on the map.  First we need to plot the data using the plot() command.

```{r,eval=FALSE}
## first plot the data
plot(L7[[1]])
## specify how many points you want to select
nclicks=5
d=click(L7,xy=T,n=nclicks,cell=T,id=TRUE,type="l")
## now click on the map to select your points

## reshape the data for easy plotting
d$id=1:nrow(d)
d2=melt(d,id.var=c("x","y","cell","id"));colnames(d2)=c("X","Y","Point","id","Year","NDVI")
d2$Year=as.numeric(sub("Y","",d2$Year))
p1=xyplot(NDVI~Year,groups=id,data=d2,type="l",auto.key=list(x=0,y=1))
p2=levelplot(L7[[1]],col.regions=cndvi()$col,cuts=length(cndvi()$at),at=cndvi()$at,margin=F)+
  layer(panel.text(d$x,d$y,d$id,col="red",cex=2))
print(c(p1,p2,merge.legends=T))
```
### Exercise: 
1. Explore the map for areas you are familiar with. Do you see any patterns?
2. Can you identify any fires looking at the NDVI profiles?


```{r,purl,echo=FALSE,results='hide',messages=F,error=FALSE,background=T}
## this chunk outputs a copy of this script converted to a 'normal' R file with comments
purl("workflow/ExploreNDVI/ExploreNDVI.Rmd",documentation=2,output = "workflow/ExploreNDVI/ExploreNDVI.R", quiet = TRUE) 
```
